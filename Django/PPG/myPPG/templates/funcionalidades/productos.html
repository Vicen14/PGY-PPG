{% load static %}
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>PixelPlay Games — Productos</title>
  <link rel="stylesheet" href="{% static 'CSS/styles.css' %}">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
        crossorigin="anonymous">
</head>
<body class="bg-custom">

<header class="container header bg-custom text-primary mb-4">
  <a href="{% url 'index' %}" class="brand d-inline-flex align-items-center" aria-label="Ir al inicio">
  <img src="{% static 'img/ppg-logo.png' %}" alt="PixelPlay Games" class="ppg-logo">
  </a>

  <nav class="nav">
    <a href="{% url 'index' %}">Inicio</a>
    <a href="{% url 'categoria_accion' %}">Acción</a>
    <a href="{% url 'categoria_deportes' %}">Deportes</a>
    <a href="{% url 'categoria_aventura' %}">Aventura</a>
    <a href="{% url 'categoria_carreras' %}">Carreras</a>
    <a href="{% url 'categoria_indie' %}">Indie</a>
    <a href="{% url 'carrito' %}" class="btn btn-outline-primary btn-sm" id="verCarrito">Carrito</a>
  </nav>

  <nav class="nav" id="navUsuario">
    <a href="{% url 'login' %}" class="btn btn-primary btn-sm" id="loginLink">Iniciar sesión</a>
    <a href="{% url 'perfil' %}" class="text-primary md d-none" id="perfilLink">Mi Perfil</a>
    <a href="{% url 'admin_panel' %}" class="admin-btn btn-sm d-none" id="adminLink">Admin</a>
    <a href="{% url 'registro' %}" class="btn btn-outline-primary btn-sm" id="registroLink">Registrarse</a>
    <span class="user-welcome d-none" id="userWelcome"></span>
    <button class="btn logout-btn btn-sm d-none" id="logoutBtn" onclick="handleLogout()">Cerrar sesión</button>
  </nav>
</header>

<main class="container text-white">
  <h2 class="mb-3">Todos los productos</h2>
  <div class="row" id="gridProductos"></div>
</main>

<footer class="container footer bg-custom text-primary mt-4">
  <div>© 2025 PixelPlay Games — Sitio demostrativo para actividad PGY3221.</div>
</footer>

<script>
  function fmtCLP(n){ 
    return new Intl.NumberFormat('es-CL',{style:'currency',currency:'CLP',maximumFractionDigits:0}).format(n||0); 
  }
  function pintarProductos(){
    const grid = document.getElementById('gridProductos');
    const productos = JSON.parse(localStorage.getItem('productos')||'[]');
    grid.innerHTML = '';
    productos.forEach(p => {
      const col = document.createElement('div');
      col.className = 'col-md-4 mb-4';
      col.innerHTML = `
        <article class="category-card">
          <div class="category-thumb">
            <img src="${p.imagen||'img/ppg-logo.png'}" alt="Imagen de ${p.nombre}">
          </div>
          <div class="category-content">
            <h3>${p.nombre}</h3>
            <p class="small text-muted">${p.categoria||''}</p>
            <div class="price">${fmtCLP(p.precio)}</div>
            <button class="btn btn-primary mt-2" data-id="${p.id}" data-add>Agregar al carrito</button>
          </div>
        </article>`;
      grid.appendChild(col);
    });
  }
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('button[data-add]');
    if(!btn) return;
    const id = Number(btn.dataset.id);
    const productos = JSON.parse(localStorage.getItem('productos')||'[]');
    const p = productos.find(x=>x.id===id);
    if(!p) return;
    addToCart({ id: p.id, name: p.nombre, price: p.precio, thumb: p.imagen, qty: 1 });
  });
  document.addEventListener('DOMContentLoaded', ()=>{
    if(!localStorage.getItem('productos')) localStorage.setItem('productos', JSON.stringify([]));
    pintarProductos();
  });
  
  function handleLogout() {
    localStorage.removeItem('usuarioActual');
    window.location.href = "{% url 'index' %}";
  }
</script>

<script src="{% static 'js/validaciones.js' %}" defer></script>
<script src="{% static 'js/carrito.js' %}" defer></script>
</body>
</html>