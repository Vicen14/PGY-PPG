{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Carrito - PixelPlay Games</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{% static 'CSS/styles.css' %}" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body class="bg-custom container py-4" id="ppg-cart-page">
  <header class="mb-4 d-flex align-items-center gap-2">
    <h1 class="text-primary m-0">üõí Carrito</h1>
    <a class="btn btn-link" href="{% url 'index' %}">‚Üê Seguir comprando</a>
  </header>

  <p id="ppg-cart-empty" class="alert alert-info" style="display:none;">Tu carrito est√° vac√≠o.</p>

  <div class="table-responsive">
    <table id="ppg-cart-table" class="table align-middle">
      <thead>
        <tr>
          <th>Producto</th>
          <th style="width:140px;">Cantidad</th>
          <th>Precio</th>
          <th>Total</th>
          <th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="d-flex justify-content-between align-items-center mt-3">
    <button id="ppg-clear-cart" class="btn btn-outline-danger">Vaciar carrito</button>
    <div class="fs-5">Total a pagar: <strong id="ppg-cart-total">$0</strong></div>
  </div>

  <div class="mt-3">
    <button id="ppg-checkout" class="btn btn-success">Ir a pagar</button>
  </div>

  <script src="{% static 'js/carrito.js' %}"></script>
  <script>
    // Script para renderizar el carrito
    document.addEventListener('DOMContentLoaded', function() {
      const cart = JSON.parse(localStorage.getItem('ppg_cart') || '[]');
      const tableBody = document.querySelector('#ppg-cart-table tbody');
      const emptyEl = document.getElementById('ppg-cart-empty');
      const totalEl = document.getElementById('ppg-cart-total');
      
      if (cart.length === 0) {
        emptyEl.style.display = 'block';
        return;
      }
      
      emptyEl.style.display = 'none';
      
      let total = 0;
      tableBody.innerHTML = cart.map(item => {
        const itemTotal = item.price * item.qty;
        total += itemTotal;
        
        return `
          <tr>
            <td>
              <div class="d-flex align-items-center gap-3">
                <img src="${item.img}" alt="${item.name}" style="width:64px;height:64px;object-fit:cover;border-radius:4px;">
                <div>
                  <div class="fw-semibold">${item.name}</div>
                </div>
              </div>
            </td>
            <td>
              <div class="input-group input-group-sm" style="width:120px;">
                <button class="btn btn-outline-secondary" onclick="updateQty('${item.id}', ${item.qty - 1})">‚àí</button>
                <input type="number" class="form-control text-center" value="${item.qty}" min="1" onchange="updateQty('${item.id}', this.value)">
                <button class="btn btn-outline-secondary" onclick="updateQty('${item.id}', ${item.qty + 1})">+</button>
              </div>
            </td>
            <td>$${item.price.toLocaleString('es-CL')}</td>
            <td>$${itemTotal.toLocaleString('es-CL')}</td>
            <td class="text-end">
              <button class="btn btn-sm btn-danger" onclick="removeItem('${item.id}')">Eliminar</button>
            </td>
          </tr>
        `;
      }).join('');
      
      totalEl.textContent = `$${total.toLocaleString('es-CL')}`;
    });
    
    function updateQty(id, newQty) {
      const cart = JSON.parse(localStorage.getItem('ppg_cart') || '[]');
      const itemIndex = cart.findIndex(item => item.id === id);
      
      if (itemIndex !== -1) {
        if (newQty < 1) {
          cart.splice(itemIndex, 1);
        } else {
          cart[itemIndex].qty = parseInt(newQty);
        }
        
        localStorage.setItem('ppg_cart', JSON.stringify(cart));
        location.reload();
      }
    }
    
    function removeItem(id) {
      const cart = JSON.parse(localStorage.getItem('ppg_cart') || '[]');
      const newCart = cart.filter(item => item.id !== id);
      localStorage.setItem('ppg_cart', JSON.stringify(newCart));
      location.reload();
    }
    
    document.getElementById('ppg-clear-cart').addEventListener('click', function() {
      if (confirm('¬øEst√°s seguro de que quieres vaciar el carrito?')) {
        localStorage.removeItem('ppg_cart');
        location.reload();
      }
    });
    
    document.getElementById('ppg-checkout').addEventListener('click', function() {
      alert('¬°Gracias por tu compra! Esta es una simulaci√≥n de proceso de pago.');
    });
  </script>
</body>
</html>